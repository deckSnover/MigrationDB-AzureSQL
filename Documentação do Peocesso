---

### Documentação de Migração de Banco de Dados SQL Server para Azure SQL Database

#### Introdução

Este repositório contém a documentação e scripts necessários para migrar um sistema legado baseado em SQL Server para a plataforma de nuvem Azure SQL Database. O processo visa escalabilidade, redução de custos e otimização de desempenho na nuvem Azure.

#### Tecnologias Utilizadas

- SQL Server
- Azure SQL Database
- Azure Database Migration Service (DMS)
- Data Migration Assistant (DMA)

#### Estrutura do Repositório

```
migracao-sql-server-para-azure-sql-db/
├── README.md
├── scripts/
│   ├── backup.sql
│   ├── migration.ps1
├── img/
│   ├── step1.png
│   ├── step2.png
│   ├── ...
└── docs/
    ├── avaliacao.md
    ├── preparacao.md
    ├── configuracao.md
    ├── migracao.md
    ├── pos-migracao.md
    ├── otimizacao.md
    ├── troubleshooting.md
```

#### Como Utilizar

Siga os documentos detalhados abaixo para reproduzir o processo de migração e otimização.

#### Etapas da Migração

1. [Avaliação e Planejamento](#avaliação-e-planejamento)
2. [Preparação do Ambiente](#preparação-do-ambiente)
3. [Configuração do Azure SQL Database](#configuração-do-azure-sql-database)
4. [Migração dos Dados](#migração-dos-dados)
5. [Pós-Migração](#pós-migração)
6. [Otimização de Performance](#otimização-de-performance)
7. [Troubleshooting](#troubleshooting)

---

#### Avaliação e Planejamento

##### Ferramenta: Data Migration Assistant (DMA)

**Passos:**

1. **Instalação do DMA**: Baixe e instale o [Data Migration Assistant](https://aka.ms/dma).
   
2. **Criação de Projeto de Avaliação**:
   - Abra o DMA.
   - Clique em "New" para criar um novo projeto.
   - Selecione "Assessment" como tipo de projeto.
   - Conecte-se ao seu servidor SQL Server.
   - Selecione os bancos de dados a serem avaliados.
   - Execute a avaliação para identificar possíveis problemas de compatibilidade.

**Capturas de Tela:**
![DMA Assessment](../img/step1.png)

---

#### Preparação do Ambiente

##### Backup do Banco de Dados

**Passos:**

1. **Realize um Backup Completo**:
   - Execute o script abaixo para fazer um backup completo do banco de dados SQL Server.

   ```sql
   -- Script para realizar backup do banco de dados SQL Server
   BACKUP DATABASE [SeuBancoDeDados]
   TO DISK = N'C:\backups\SeuBancoDeDados.bak'
   WITH NOFORMAT, NOINIT,
   NAME = N'SeuBancoDeDados-Full Database Backup',
   SKIP, NOREWIND, NOUNLOAD, STATS = 10;
   GO
   ```

**Capturas de Tela:**
![Backup](../img/step2.png)

---

#### Configuração do Azure SQL Database

##### Criação do Banco de Dados no Azure

**Passos:**

1. **Criar uma Nova Instância do Azure SQL Database**:
   - No [Azure Portal](https://portal.azure.com), navegue até o serviço "Azure SQL".
   - Clique em "Criar".
   - Preencha as informações necessárias, como nome do banco de dados, servidor, etc.
   - Selecione o nível de desempenho adequado.

2. **Configuração do Azure Database Migration Service (DMS)**:
   - No Azure Portal, configure o Azure Database Migration Service.
   - Navegue até "Azure Database Migration Services".
   - Clique em "Criar".
   - Preencha as informações e crie o serviço.

**Capturas de Tela:**
![Create Azure SQL Database](../img/step3.png)

---

#### Migração dos Dados

##### Utilizando o Azure Database Migration Service (DMS)

**Passos:**

1. **Configurar o Projeto de Migração**:
   - No DMS, crie um novo projeto de migração.
   - Selecione "Online data migration" ou "Offline data migration".
   - Conecte-se ao servidor SQL Server de origem.
   - Conecte-se ao Azure SQL Database de destino.
   - Selecione os bancos de dados a serem migrados.

2. **Iniciar a Migração**:
   - Execute o script abaixo para iniciar a migração.

   ```powershell
   # Script PowerShell para configurar e iniciar a migração utilizando o Azure Database Migration Service (DMS)

   # Parâmetros
   $sourceSqlConnectionString = "Server=seu_servidor_sql_server;Database=SeuBancoDeDados;User Id=seu_usuario;Password=sua_senha;"
   $targetSqlConnectionString = "Server=seu_servidor_azure_sql.database.windows.net;Database=SeuBancoDeDados;User Id=seu_usuario;Password=sua_senha;"

   # Instalar módulo do Azure
   Install-Module -Name Az -AllowClobber -Force

   # Login no Azure
   Connect-AzAccount

   # Criar serviço de migração
   New-AzDmsService -ResourceGroupName "seu_grupo_de_recursos" -ServiceName "seu_servico_de_migracao" -Location "East US" -Sku "Basic_1vCore"

   # Configurar projeto de migração
   New-AzDmsProject -ResourceGroupName "seu_grupo_de_recursos" -ServiceName "seu_servico_de_migracao" -ProjectName "seu_projeto_de_migracao" -SourcePlatform "SQL" -TargetPlatform "AzureDb"

   # Iniciar migração
   Start-AzDmsMigration -ResourceGroupName "seu_grupo_de_recursos" -ServiceName "seu_servico_de_migracao" -ProjectName "seu_projeto_de_migracao" -SourceSqlConnectionString $sourceSqlConnectionString -TargetSqlConnectionString $targetSqlConnectionString -DatabaseName "SeuBancoDeDados"
   ```

**Capturas de Tela:**
![DMS Migration](../img/step4.png)

---

#### Pós-Migração

##### Validação e Otimização

**Passos:**

1. **Validação de Dados**:
   - Verifique se todos os dados foram migrados corretamente.

---

#### Otimização de Performance

##### Práticas Recomendadas

**Índices e Estatísticas**

1. **Criação de Índices Adequados**:
   - Analise consultas frequentes e crie índices não-clusterizados para colunas usadas em cláusulas WHERE e JOIN.
   - Considere índices clusterizados para colunas de chave primária ou agrupamento natural.

2. **Atualização de Estatísticas**:
   - Configure jobs de atualização automática de estatísticas para garantir que o otimizador de consultas faça decisões precisas.

**Configuração de Recursos**

1. **Ajuste de Configurações de Recursos do Azure SQL Database**:
   - Ajuste o nível de serviço (DTU ou vCore) com base na carga de trabalho e na demanda de desempenho.
   - Utilize pools elásticos para distribuir recursos entre vários bancos de dados.

**Monitoramento e Diagnóstico**

1. **Configuração de Logs de Auditoria e Diagnóstico**:
   - Ative a auditoria do Azure SQL Database para rastrear atividades de acesso e alterações.
   - Configure alertas no Azure Monitor para notificações proativas sobre problemas de desempenho.

**Query Performance Insights**

1. **Análise de Desempenho de Consultas**:
   - Utilize o Query Performance Insight para identificar consultas de alto consumo de recursos.
   - Aplique ajustes como reescrita de consultas ou alteração de índices conforme necessário.

**Escalabilidade e Disponibilidade**

1. **Implementação de Elastic Pools**:
   - Agrupe bancos de dados com cargas de trabalho variáveis em pools elásticos para otimizar recursos e reduzir custos.

2. **Configuração de Replicação Geográfica**:
   - Implemente replicação geográfica para distribuir leituras e garantir alta disponibilidade em várias regiões.

**Capturas de Tela:**
![Azure SQL Performance](../img/otimizacao.png)

---

**Troubleshooting**

##### Problema: Performance de Consulta Baixa após a Migração

**Causa Potencial: Falta de Índices Adequados**

- Verifique se as consultas estão sendo executadas sem o suporte de índices apropriados. Isso pode levar a escaneamentos completos de tabelas e baixo desempenho geral.

**Solução: Criação de Índices**

- Identifique consultas lentas usando ferramentas como Query Performance Insight.
- Crie índices não-clusterizados para colunas frequentemente usadas em cláusulas WHERE e JOIN.
- Considere índices clusterizados para colunas de chave primária ou agrupamento natural.

##### Problema: Falhas na Migração de Dados

**Causa Potencial: Conexão ou Configuração do DMS**

- Problemas de configuração podem impedir a migração correta dos dados entre SQL Server e Azure SQL Database.

**Solução: Verificação e Reconfiguração**

- Verifique as configurações de conexão do Azure Database Migration Service (DMS).
- Certifique-se de que as credenciais de conexão estejam corretas e que ambos os servidores (origem e destino) sejam acessíveis.

---
